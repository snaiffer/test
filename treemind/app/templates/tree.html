<!-- extend from base layout -->
{% extends "base.html" %}

{% block content %}

  <head>
    <link rel="stylesheet" href="{{ url_for('static', filename='themes/default/tree/style.css') }}" />

    <script src="{{ url_for('static', filename='libs/jstree/jstree.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='libs/jstree/themes/default/style.css') }}" />

    <script src="{{ url_for('static', filename='libs/splitter/jquery.splitter-0.14.0.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='libs/splitter/themes/default/jquery.splitter.css') }}" />

    <script src="{{ url_for('static', filename='libs/ckeditor/ckeditor.js') }}"></script>
  </head>

    <table id="headline">
      <tr>
        <td id="control_board">
          <table style="width: 100%;">
            <td>
              <img id="btnTree"
                src="{{ url_for('static', filename='themes/default/tree/btnTree.png') }}"
                alt="The tree"/>
              <select id="selectTrees">
                {% if trees %}
                  {% for tree in trees %}
                    {% if tree.name == curtree_name %}
                      <option selected="selected">{{ tree.name }}</option>
                    {% else %}
                      <option>{{ tree.name }}</option>
                    {% endif %}
                  {% endfor %}
                {% endif %}
              </select>
            </td>
            <td>
              <img id="btnSettings" class='CBbtn'
                src="{{ url_for('static', filename='themes/default/tree/btnSettings.png') }}"
                alt="Make settings" title="settings"/>
              <img id="btnSearch" class='CBbtn'
                src="{{ url_for('static', filename='themes/default/tree/btnSearch.png') }}"
                alt="Search" title="search"/>
            </td>
          </table>
        </td>
        <td id="ckeditor_board">
          <div id="ckeditor_toolbar"></div>
          <div id="ckedit_activator" contenteditable="false" style="display: none;"></div>
        </td>
      </tr>
    </table>

    <div id="wrapper">
      <div id="tree_field">
        <div id="tree"></div>
      </div>
      <div id="nestedocs_field">
        <div id="nestedocs"></div>
      </div>
    </div>

    <script>
    $(function() {
      var ckedit_inst = CKEDITOR.inline( document.getElementById("ckedit_activator") );   // tie CKEDITOR with this element while other elements aren't created
      // waitting while ckeditor will be activated and then build 'splitter'. In other case size of '$('#headline').height()' will be wrong
      ckedit_inst.on('instanceReady', function() {
        $('#wrapper').height($(window).height()-$('#headline').height()).split({orientation:'vertical', position:'38%'});
      })

      var clipboard;
      $('#tree')
        .jstree({
          'core' : {
            'data' : {
              "url" : "/mngtree?tree_name={{curtree_name}}&nestedocs=false&cmd=load_subbs",
              "data" : function (node) {
                  return { "id" : node.id };
                },
              "dataType" : "json"
            },
            'locked' : true // access all operations with tree
          },
          "plugins" : [ "contextmenu", "dnd" ],
          "dnd" : {
            "is_draggable" : true
          }
        })
        // invoked after jstree has loaded
        .on("ready.jstree", function (e, data) {
          $(this).jstree(true).select_node({{latestUsedB}});
        })
        .on("create_node.jstree", function (e, data) {
          $.get("/mngtree?tree_name={{curtree_name}}&nestedocs=false&cmd=create_node" +
            "&position=" + data.position +
            "&parent_id=" + data.parent
            , $.proxy(function(id) {
            id = Number(id);
            $(this).jstree(true).set_id(data.node, id);
          }, this))
        })
        .on("delete_node.jstree", function (e, data) {
          $.get("/mngtree?tree_name={{curtree_name}}&nestedocs=false&cmd=delete_node&id=" + data.node.id)
          $(this).jstree(true).select_node(data.parent);
        })
        .on("after_close.jstree", function (e, data) {
          $.get("/mngtree?tree_name={{curtree_name}}&nestedocs=false&cmd=fold&id=" + data.node.id)
        })
        .on("after_open.jstree", function (e, data) {
          $.get("/mngtree?tree_name={{curtree_name}}&nestedocs=false&cmd=unfold&id=" + data.node.id)
        })
        .on("rename_node.jstree", function (e, data) {
          $.post("/mngtree", { tree_name : "{{curtree_name}}", nestedocs : "false", cmd : "rename_node", id : data.node.id, data : data.text })
        })
        .on("move_node.jstree", function (e, data) {
          $.get("/mngtree?tree_name={{curtree_name}}&nestedocs=false&cmd=move_node&id=" + data.node.id +
            "&position=" + data.position +
            "&new_parent=" + data.parent
            )
        })
        .on("changed.jstree", function (e, data) {
          if (data.selected.length == 1) {
            var branch_id = data.selected[0];

            $('#nestedocs').jstree('destroy');
            $('#nestedocs')
              .jstree({
                'core' : {
                  'data' : {
                    "url" : "/mngtree?tree_name={{curtree_name}}&nestedocs=true&cmd=load_subbs",
                    "data" : function (node) {
                        if (node.id == '#') {
                          return { "id" : branch_id };
                        } else {
                          return { "id" : node.id };
                        }
                      },
                    "dataType" : "json"
                  },
                  'locked' : true // access all operations with tree
                },
                "plugins" : ["contextmenu", "dnd", "ckeditor_support" ],
                "dnd" : {
                  "is_draggable" : true
                }
                /*
                "plugins" : ["wholerow", "contextmenu", "dnd", "search", "ckeditor_support" ],
                */
              })
              .on("create_node.jstree", function (e, data) {
                $.get("/mngtree?tree_name={{curtree_name}}&nestedocs=true&cmd=create_node" +
                  "&position=" + data.position +
                  "&parent_id=" + data.parent
                  , $.proxy(function(id) {
                  id = Number(id);
                  $(this).jstree(true).set_id(data.node, id);
                }, this))
              })
              .on("delete_node.jstree", function (e, data) {
                $.get("/mngtree?tree_name={{curtree_name}}&nestedocs=true&cmd=delete_node&id=" + data.node.id)
                $(this).jstree(true).select_node(data.parent);
              })
              .on("after_close.jstree", function (e, data) {
                $.get("/mngtree?tree_name={{curtree_name}}&nestedocs=true&cmd=fold&id=" + data.node.id)
              })
              .on("after_open.jstree", function (e, data) {
                $.get("/mngtree?tree_name={{curtree_name}}&nestedocs=true&cmd=unfold&id=" + data.node.id)
              })
              .on("move_node.jstree", function (e, data) {
                $.get("/mngtree?tree_name={{curtree_name}}&nestedocs=true&cmd=move_node&id=" + data.node.id +
                  "&new_parent=" + data.parent +
                  "&position=" + data.position
                  )
              })
              .on("clipboard_save.jstree", function (e, data) {
                console.log('clipboard_save');
                clipboard = data;
                console.log(clipboard);
              })
              .on("clipboard_get.jstree", function (e, data) {
                console.log('clipboard_get');
                return clipboard;
              })
              .on("savedata.jstree", function (e, data) {
                $.post("/mngtree", { tree_name : "{{curtree_name}}", nestedocs : "true", cmd : "save_data", id : data.id, data : data.text })
              });
          }
        });

        // set focus to the tree
        $('#nestedocs_field, #tree_field')
          .on('click', function(e) {
            var curTree = $(this).children('.jstree').jstree(true);
            if (curTree) {
              curTree.deselect_all();
              if (curTree._data.core.focusedT == false) {
                curTree.trigger('focus');
              }
            }
          })
          .on('mouseenter', function(e) {
            var curTree = $(this).children('.jstree').jstree(true);
            if (curTree && curTree._data.core.focusedT == false) {
              curTree.trigger('focus');
              curTree.trigger('click');
            }
          })
          .on('mouseleave', function(e) {
            var curTree = $(this).children('.jstree').jstree(true);
            if (curTree && curTree._data.core.focusedT == true) {
              curTree._data.core.focusedT = false;
            }
          });
        //

        $('#btnUser').on('click', function(e) {
          location.href='/user';
        });
        $('#btnSettings').on('click', function(e) {
          alert("Setting board is under development");
        });
        $('#btnSearch').on('click', function(e) {
          alert("Search function is under development");
        });
        $('#btnLogOut').on('click', function(e) {
          location.href='/logout';
        });
        $('#selectTrees').on('change', function(e) {
          var optionSelected = $("option:selected", this);
          var valueSelected = this.value;
          location.href='/trees/' + valueSelected;
        });
    });
    </script>
{% endblock %}
