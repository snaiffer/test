<!DOCTYPE html>

<html>
  <head>
    <script src="libs/jquery-1.11.1.min.js"></script>

    <script src="libs/jstree/jstree.js"></script>
    <link rel="stylesheet" href="libs/jstree/themes/default/style.css" />

    <script src="libs/splitter/jquery.splitter-0.14.0.js"></script>
    <link rel="stylesheet" href="libs/splitter/themes/default/jquery.splitter.css" />

    <script src="libs/ckeditor/ckeditor.js"></script>
  </head>

  <body>
    <div id="wrapper">
      <div id="left_field">
        <div id="tree"></div>
      </div>
      <div id="right_field">
        <textarea id="data">None</textarea>
        <div id="nestedocs"></div>
        <div id="click_absorbent"><a>.</a></div>
      </div>
    </div>

    <script>
    $(function() {
      $('#wrapper').width($(document).width()).height($(document).height()).split({orientation:'vertical', limit:100, position:'38%'});

      $('#nestedocs').jstree({
        'core' : {
          'data' : {
            "url" : "/cgi-bin/treemind.py?cmd=load_subbs&id=",
            "data" : function (node) {
                if( node.id == '#' ){
                  return { "id" : 1 };
                } else {
                  return { "id" : node.id };
                }
              },
            "dataType" : "json"
          },
          'check_callback' : true // access all operations with tree
            /*
            'data' : [
            { "text" : "Root node", "children" : [
                { "text" : "Child node 1" },
                { "text" : "Child node 2" }
            ]},
            { "text" : "Root node", "children" : [
                { "text" : "Child node 1" },
                { "text" : "Child node 2" }
            ]
            ]
                */
        },
        "plugins" : ["dnd", "ckeditor_support" ],
        "dnd" : {
          "is_draggable" : true
        }
        /*
        "plugins" : ["wholerow", "contextmenu", "dnd", "search", "ckeditor_support" ],
        */
      });

      /*
      $('#tree')
        // invoked after jstree has loaded
        .bind('loaded.jstree', function(e, data) {
          $(this).jstree(true).select_node('2'); //Replaced 2 for the latest used branch_id from the last session
        })
        .jstree({
          'core' : {
            'data' : {
              "url" : "/cgi-bin/treemind.py?cmd=load_subbs&id=",
              "data" : function (node) {
                  if( node.id == '#' ){
                    return { "id" : 1 };
                  } else {
                    return { "id" : node.id };
                  }
                },
              "dataType" : "json"
            },
            'check_callback' : true // access all operations with tree
          },
          "plugins" : ["wholerow", "contextmenu", "dnd", "search" ],
          "dnd" : {
            "is_draggable" : true
          }
        })
        .on("create_node.jstree", function (e, data) {
          $.get("/cgi-bin/treemind.py?cmd=" + "create_node&parent_id=" + data.parent, function(id) {
            id = Number(id);
            $("#tree").jstree().set_id(data.node, id);
          })
        })
        .on("delete_node.jstree", function (e, data) {
          $.get("/cgi-bin/treemind.py?cmd=delete_node&id=" + data.node.id)
        })
        .on("rename_node.jstree", function (e, data) {
          $.post("/cgi-bin/treemind.py", { cmd : "rename_node", id : data.node.id, caption : data.text })
        })
        .on("changed.jstree", function (e, data) {
          if (data.selected.length == 1) {
            $.get("/cgi-bin/treemind.py?cmd=load_data&id=" + data.selected, function(data) {
              $('#data').val(data)
            });
            $('#data').attr("id_intree", data.selected)
          }
        })
        .on("move_node.jstree", function (e, data) {
          console.log(data.position)

          $.get("/cgi-bin/treemind.py?cmd=move_node&id=" + data.node.id +
            "&new_parent=" + data.parent +
            "&position=" + data.position
            )
        })
        .click(function() {
          $("#tree").jstree().load_node(2)
        });
        */

      $("#data")
        // save data after editting
        .blur(function(){
          $.post("/cgi-bin/treemind.py", { cmd : "save_data", id : $(this).attr("id_intree"), data : $(this).val() })
        });

    });
    </script>
  </body>
</html>
