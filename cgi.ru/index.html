<!DOCTYPE html>

<html>
  <head>
    <script src="libs/jquery-1.11.1.min.js"></script>
    <script src="libs/jstree/jstree.min.js"></script>
    <link rel="stylesheet" href="libs/jstree/themes/default/style.min.css" />
    <link rel="stylesheet" href="main.css">
  </head>

  <body>
    <div id="wrapper">
      <div id="first">
        <div id="tree"></div>
      </div>
      <div id="second">
        <textarea id="data">None</textarea>
        <!--<p id="test"> test </p>-->
      </div>
    </div>



    <script>
    $(function() {
      $('#tree')
        // invoked after jstree has loaded
        .bind('loaded.jstree', function(e, data) {
          $(this).jstree(true).select_node('2'); //Replaced 2 for the latest used branch_id from the last session
        })
        .jstree({
          'core' : {
            'data' : {
              "url" : "/cgi-bin/treemind.py?cmd=load_subbs&id=",
              "data" : function (node) {
                  if( node.id == '#' ){
                    return { "id" : 1 };
                  } else {
                    return { "id" : node.id };
                  }
                },
              "dataType" : "json"
            },
            'check_callback' : true // access all operations with tree
          },
          "plugins" : ["wholerow", "contextmenu", "dnd", "search" ],
          "dnd" : {
            "is_draggable" : true
          }
        });

      $('#tree').on("create_node.jstree", function (e, data) {
        $.get("/cgi-bin/treemind.py?cmd=" + "create_node&parent_id=" + data.parent, function(id) {
          id = Number(id);
          $("#tree").jstree().set_id(data.node, id);
        })
      });

      $('#tree').on("delete_node.jstree", function (e, data) {
        $.get("/cgi-bin/treemind.py?cmd=delete_node&id=" + data.node.id)
      });

      $('#tree').on("rename_node.jstree", function (e, data) {
        $.post("/cgi-bin/treemind.py", { cmd : "rename_node", id : data.node.id, caption : data.text })
      });

      $('#tree').on("changed.jstree", function (e, data) {
        if (data.selected.length == 1) {
          $.get("/cgi-bin/treemind.py?cmd=load_data&id=" + data.selected, function(data) {
            $('#data').val(data)
          });
          $('#data').attr("id_intree", data.selected)
        }
      });

      $('#tree').on("move_node.jstree", function (e, data) {
        $.get("/cgi-bin/treemind.py?cmd=move_node&id=" + data.node.id +
          "&new_parent=" + data.parent)
      });

      $("#data")
        // save data after editting
        .blur(function(){
          $.post("/cgi-bin/treemind.py", { cmd : "save_data", id : $(this).attr("id_intree"), data : $(this).val() })
        });

      $("#test").click(function() {
        $("#tree").jstree().load_node(2)
      });

    });

    </script>
  </body>
</html>
