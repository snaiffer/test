<!DOCTYPE html>

<html>
  <head>
    <script src="libs/jquery-1.11.1.min.js"></script>

    <script src="libs/jstree/jstree.js"></script>
    <link rel="stylesheet" href="libs/jstree/themes/default/style.css" />

    <script src="libs/splitter/jquery.splitter-0.14.0.js"></script>
    <link rel="stylesheet" href="libs/splitter/themes/default/jquery.splitter.css" />

    <script src="libs/ckeditor/ckeditor.js"></script>
  </head>

  <body>
    <!--<div id="wrapper" style="background-color: #79795D;">-->
    <div id="wrapper">
      <div id="left_field">
        <div id="tree"></div>
      </div>
      <div id="right_field">
        <div id="ckeditor_toolbar"></div>
        <div id="data_field">
          <div id="nestedocs"></div>
          <!--<div id="click_absorbent"><a>&nbsp</a></div>-->
        </div>
      </div>
    </div>

    <script>
    $(function() {
      $('#wrapper').height($(window).height()-16).split({orientation:'vertical', position:'38%'});
      $('#right_field').split({orientation:'horizontal', position: '10px'});

      $('#tree')
        .jstree({
          'core' : {
            'data' : {
              "url" : "/cgi-bin/treemind.py?nestedocs=False&cmd=load_subbs",
              "data" : function (node) {
                  if( node.id == '#' ){
                    return { "id" : 1 };
                  } else {
                    return { "id" : node.id };
                  }
                },
              "dataType" : "json"
            },
            'check_callback' : true // access all operations with tree
          },
          "plugins" : ["wholerow", "contextmenu", "dnd" ],
          "dnd" : {
            "is_draggable" : true
          }
        })
        // invoked after jstree has loaded
        .on("ready.jstree", function (e, data) {
          $(this).jstree(true).select_node('4'); //Replaced 2 for the latest used branch_id from the last session
        })
        .on("create_node.jstree", function (e, data) {
          $.get("/cgi-bin/treemind.py?nestedocs=False&cmd=create_node&parent_id=" + data.parent, $.proxy(function(id) {
            id = Number(id);
            $(this).jstree(true).set_id(data.node, id);
          }, this))
        })
        .on("delete_node.jstree", function (e, data) {
          $.get("/cgi-bin/treemind.py?nestedocs=False&cmd=delete_node&id=" + data.node.id)
          $(this).jstree(true).select_node(data.parent);
        })
        .on("rename_node.jstree", function (e, data) {
          $.post("/cgi-bin/treemind.py", { nestedocs : "False", cmd : "rename_node", id : data.node.id, caption : data.text })
        })
        .on("move_node.jstree", function (e, data) {
          $.get("/cgi-bin/treemind.py?nestedocs=False&cmd=move_node&id=" + data.node.id +
            "&new_parent=" + data.parent +
            "&position=" + data.position
            )
        })
        .on("changed.jstree", function (e, data) {
          if (data.selected.length == 1) {
            var branch_id = data.selected[0];

            $('#nestedocs').jstree('destroy');
            $('#nestedocs')
              .jstree({
                'core' : {
                  'data' : {
                    "url" : "/cgi-bin/treemind.py?nestedocs=True&cmd=load_subbs",
                    "data" : function (node) {
                        return { "id" : branch_id };
                      },
                    "dataType" : "json"
                  },
                  'check_callback' : true // access all operations with tree
                },
                "plugins" : ["contextmenu", "dnd", "ckeditor_support" ],
                "dnd" : {
                  "is_draggable" : true
                }
                /*
                "plugins" : ["wholerow", "contextmenu", "dnd", "search", "ckeditor_support" ],
                */
              })
              .on("create_node.jstree", function (e, data) {
                $.get("/cgi-bin/treemind.py?nestedocs=True&cmd=create_node&parent_id=" + data.parent, $.proxy(function(id) {
                  id = Number(id);
                  $(this).jstree(true).set_id(data.node, id);
                }, this))
              })
              .on("delete_node.jstree", function (e, data) {
                $.get("/cgi-bin/treemind.py?nestedocs=True&cmd=delete_node&id=" + data.node.id)
                $(this).jstree(true).select_node(data.parent);
              })
              .on("move_node.jstree", function (e, data) {
                $.get("/cgi-bin/treemind.py?nestedocs=True&cmd=move_node&id=" + data.node.id +
                  "&new_parent=" + data.parent +
                  "&position=" + data.position
                  )
              })
              .on("savedata.jstree", function (e, data) {
                $.post("/cgi-bin/treemind.py", { nestedocs : "True", cmd : "save_data", id : data.id, data : data.text })
              });
          }
        });

        // set focus to the tree
        $('#data_field')
          .on('click', function(e) {
            var curTree = $('#nestedocs');
            curTree.jstree(true).deselect_all();
            $(this).trigger('mouseenter');
          })
          .on('mouseenter', function(e) {
            var curTree = $('#nestedocs');
            if ( curTree.jstree(true)._data.core.focused == null ) {
              curTree.trigger('focus');
            }
          });
        $('#left_field')
          .on('click', function(e) {
            var curTree = $('#tree');
            curTree.jstree(true).deselect_all();
            $(this).trigger('mouseenter');
          })
          .on('mouseenter', function(e) {
            var curTree = $('#tree');
            if ( curTree.jstree(true)._data.core.focused == null ) {
              curTree.trigger('focus');
            }
          });
          /*
        $('#data_field, #left_field')
          .on('click', function(e) {
            var curTree = $(this).children('.jstree');
            curTree.jstree(true).deselect_all();
            $.proxy(function () { $(this).trigger('mouseenter'); }, this)
          })
          .on('mouseenter', function(e) {
            var curTree = $(this).children('.jstree');
            if ( curTree.jstree(true)._data.core.focused == null ) {
              curTree.trigger('focus');
            }
          });
          */
        //
    });
    </script>
  </body>
</html>
